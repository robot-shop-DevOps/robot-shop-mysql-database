apiVersion: apps/v1

kind: StatefulSet

metadata:
  name: {{ .Values.microservice }}

  labels:
{{ .Values.labels | toYaml | indent 4 }}

spec:
  selector:
    matchLabels:
{{ .Values.labels | toYaml | indent 6 }}

  serviceName: {{ .Values.service.name }}

  replicas: {{ .Values.statefulset.replicas }}

  updateStrategy:
{{ .Values.statefulset.updateStrategy | toYaml | indent 4 }}

  template:
    metadata:
      labels:
{{ .Values.labels | toYaml | indent 8 }}

    spec:
      nodeSelector:
{{ .Values.statefulset.pod.nodeSelector | toYaml | indent 8 }}

      containers:
      - name: {{ .Values.microservice }}

        image: "{{ .Values.statefulset.pod.container.image.repo }}:{{ .Values.statefulset.pod.container.image.version }}"

        imagePullPolicy: {{ .Values.statefulset.pod.container.image.pullPolicy }}

        ports:
        - containerPort: {{ .Values.statefulset.pod.container.port }}

        env:
{{ .Values.statefulset.pod.container.env | toYaml | indent 10 }}

        volumeMounts:
{{ .Values.statefulset.pod.container.volumeMounts | toYaml | indent 10 }}

  volumeClaimTemplates:
{{ .Values.statefulset.volumeClaimTemplates | toYaml | indent 4 }}